---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: vikunja-restart
  namespace: data
spec:
  schedule: "@weekly"
  jobTemplate:
    spec:
      template:
        metadata:
          name: vikunja-restart
        spec:
          serviceAccountName: jobs
          containers:
            - name: tester
              image: bitnami/kubectl:1.21.0
              command:
                - "bin/sh"
                - "-ec"
                - |
                  #!/bin/sh

                  set -o nounset
                  set -o errexit

                  result=$(kubectl get pod --selector app.kubernetes.io/name=vikunja --output custom-columns=:metadata.name --namespace data)
                  VIKUNJA_POD=$(echo $result | awk '{ print $NF }')
                  echo $VIKUNJA_POD | grep vikunja
                  test $? -eq 0 && kubectl delete pod $VIKUNJA_POD --namespace data
                  curl -m 10 --retry 5 http://healthchecks.monitoring.svc.cluster.local:8000/ping/a1a67035-7576-4020-816b-e4ec2817a719
          restartPolicy: Never
